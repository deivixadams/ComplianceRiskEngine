// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model SecurityUser {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  email         String   @unique
  passwordHash  String   @map("password_hash")
  fullName      String?  @map("full_name")
  roleCode      String   @map("role_code")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @map("updated_at")

  @@map("security_users")
}

model SecurityRbac {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleCode       String   @map("role_code")
  permissionCode String   @map("permission_code")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("security_rbac")
}

model CorpusParam {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String   @map("tenant_id") @db.Uuid
  paramCode            String   @unique @map("param_code")
  paramName            String   @map("param_name")
  category             String
  description          String
  technicalDescription String   @map("technical_description")
  defaultValue         Decimal  @map("default_value")
  configurableValue    Decimal  @map("configurable_value")
  minAllowedValue      Decimal  @map("min_allowed_value")
  maxAllowedValue      Decimal  @map("max_allowed_value")
  requiresApproval     Boolean  @default(true) @map("requires_approval")
  isActive             Boolean  @default(true) @map("is_active")
  isLocked             Boolean  @default(false) @map("is_locked")
  versionNumber        Int      @default(1) @map("version_number")
  effectiveFrom        DateTime @default(now()) @map("effective_from")
  effectiveTo          DateTime? @map("effective_to")
  createdAt            DateTime @default(now()) @map("created_at")
  createdBy            String?  @map("created_by") @db.Uuid
  updatedAt            DateTime @default(now()) @map("updated_at")
  updatedBy            String?  @map("updated_by") @db.Uuid

  profileValues        CorpusParamProfileValue[]
  changeLogs           CorpusParamChangeLog[]

  @@map("corpus_params")
}

model CorpusParamProfile {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  profileName     String   @map("profile_name")
  jurisdictionId  String?  @map("jurisdiction_id") @db.Uuid
  versionNumber   Int      @default(1) @map("version_number")
  hashSnapshot    String?  @map("hash_snapshot")
  status          String   @default("draft")
  createdAt       DateTime @default(now()) @map("created_at")
  approvedAt      DateTime? @map("approved_at")
  approvedBy      String?  @map("approved_by") @db.Uuid
  activatedAt     DateTime? @map("activated_at")
  isActive        Boolean  @default(false) @map("is_active")

  values          CorpusParamProfileValue[]

  @@map("corpus_param_profiles")
}

model CorpusParamProfileValue {
  id        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId String             @map("profile_id") @db.Uuid
  paramId   String             @map("param_id") @db.Uuid
  value     Decimal
  createdAt DateTime           @default(now()) @map("created_at")

  profile   CorpusParamProfile @relation(fields: [profileId], references: [id])
  param     CorpusParam        @relation(fields: [paramId], references: [id])

  @@map("corpus_param_profile_values")
}

model CorpusParamChangeLog {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paramId      String      @map("param_id") @db.Uuid
  oldValue     Decimal?    @map("old_value")
  newValue     Decimal?    @map("new_value")
  changedBy    String?     @map("changed_by") @db.Uuid
  changeReason String?     @map("change_reason")
  changeType   String?     @map("change_type")
  createdAt    DateTime    @default(now()) @map("created_at")

  param        CorpusParam @relation(fields: [paramId], references: [id])

  @@map("corpus_param_change_log")
}

model CorpusJurisdiction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code      String   @unique
  name      String
  iso2      String?
  iso3      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  companies CorpusCompany[]
  frameworks CorpusFramework[]

  @@map("corpus_jurisdiction")
}

model CorpusFramework {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jurisdictionId String   @map("jurisdiction_id") @db.Uuid
  code           String   @unique
  name           String
  createdAt      DateTime @default(now()) @map("created_at")

  jurisdiction   CorpusJurisdiction @relation(fields: [jurisdictionId], references: [id])
  versions       CorpusFrameworkVersion[]

  @@map("corpus_framework")
}

model CorpusFrameworkVersion {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  frameworkId String   @map("framework_id") @db.Uuid
  version     String
  status      String   @default("active")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  framework   CorpusFramework @relation(fields: [frameworkId], references: [id])
  assessments CorpusAssessment[]
  modelRuns   CorpusModelRun[]

  @@map("corpus_framework_version")
}

model CorpusCompany {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String   @unique
  name           String
  legalName      String?  @map("legal_name")
  jurisdictionId String?  @map("jurisdiction_id") @db.Uuid
  statusId       Int      @map("status_id") @db.SmallInt
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @map("updated_at")

  jurisdiction   CorpusJurisdiction? @relation(fields: [jurisdictionId], references: [id])
  assessments    CorpusAssessment[]

  @@map("corpus_company")
}

model CorpusDomain {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String   @unique
  name         String
  description  String?
  displayOrder Int      @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  obligations  CorpusObligation[]
  scopes       CorpusEvaluationScope[]

  @@map("corpus_domain")
}

model CorpusObligation {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  domainId          String   @map("domain_id") @db.Uuid
  code              String   @unique
  title             String
  statement         String
  criticalityId     Int      @map("criticality_id") @db.SmallInt
  evidenceStrength  Int      @map("evidence_strength") @db.SmallInt
  createdAt         DateTime @default(now()) @map("created_at")

  domain            CorpusDomain @relation(fields: [domainId], references: [id])
  controls          CorpusControlObligation[]
  scopes            CorpusEvaluationScope[]
  weights           CorpusParameterObligationWeight[]
  modelRunObligations CorpusModelRunObligation[]

  @@map("corpus_obligation")
}

model CorpusControl {
  id                         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                       String   @unique
  name                       String
  controlTypeId              Int      @map("control_type_id") @db.SmallInt
  automationId               Int      @map("automation_id") @db.SmallInt
  frequencyId                Int      @map("frequency_id") @db.SmallInt
  description                String
  designDescription          String   @default("") @map("design_description")
  criticalityLevel           Int      @default(3) @map("criticality_level") @db.SmallInt
  inherentMitigationStrength Decimal  @default(1.000) @map("inherent_mitigation_strength") @db.Decimal(4, 3)
  ownerRole                  String?  @map("owner_role")
  evidenceRequired           Boolean  @default(true) @map("evidence_required")
  status                     String   @default("active")
  statusId                   Int      @map("status_id") @db.SmallInt
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @default(now()) @map("updated_at")

  evaluationStates           CorpusEvaluationControlState[]
  modelRunControls           CorpusModelRunControl[]
  obligations                CorpusControlObligation[]

  @@map("corpus_control")
}

model CorpusControlObligation {
  controlId    String @map("control_id") @db.Uuid
  obligationId String @map("obligation_id") @db.Uuid

  control      CorpusControl @relation(fields: [controlId], references: [id])
  obligation   CorpusObligation @relation(fields: [obligationId], references: [id])

  @@id([controlId, obligationId])
  @@map("corpus_control_obligation")
}

model CorpusAssessment {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  companyId           String   @map("company_id") @db.Uuid
  frameworkVersionId  String   @map("framework_version_id") @db.Uuid
  statusId            Int      @map("status_id")
  name                String
  description         String?
  createdAt           DateTime @default(now()) @map("created_at")

  company             CorpusCompany @relation(fields: [companyId], references: [id])
  frameworkVersion    CorpusFrameworkVersion @relation(fields: [frameworkVersionId], references: [id])
  evaluations         CorpusEvaluation[]
  modelRuns           CorpusModelRun[]

  @@map("corpus_assessment")
}

model CorpusEvaluation {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  assessmentId        String   @map("assessment_id") @db.Uuid
  statusId            Int      @map("status_id")
  periodStart         DateTime @map("period_start")
  periodEnd           DateTime @map("period_end")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @map("updated_at")

  assessment          CorpusAssessment @relation(fields: [assessmentId], references: [id])
  controlStates       CorpusEvaluationControlState[]
  testRuns            CorpusEvaluationTestRun[]
  artifacts           CorpusEvaluationArtifact[]
  modelRuns           CorpusModelRun[]
  scopes              CorpusEvaluationScope[]

  @@map("corpus_evaluation")
}

model CorpusEvaluationControlState {
  id                        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  evaluationId              String   @map("evaluation_id") @db.Uuid
  controlId                 String   @map("control_id") @db.Uuid
  state                     String
  
  formalizationEffectiveness Decimal? @map("formalization_effectiveness") @db.Decimal(6, 4)
  coverageEffectiveness      Decimal? @map("coverage_effectiveness") @db.Decimal(6, 4)
  recencyEffectiveness       Decimal? @map("recency_effectiveness") @db.Decimal(6, 4)
  evidenceValidated          Boolean  @default(false) @map("evidence_validated")
  applicability             String   @default("applicable") @map("applicability")
  notApplicableReason       String?  @map("not_applicable_reason")
  finalEffectiveness        Decimal? @map("final_effectiveness") @db.Decimal(6, 4)
  computedAt                DateTime? @map("computed_at")
  
  evaluation                CorpusEvaluation @relation(fields: [evaluationId], references: [id])
  control                   CorpusControl @relation(fields: [controlId], references: [id])

  @@map("corpus_evaluation_control_state")
}

model CorpusEvaluationScope {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  evaluationId String   @map("evaluation_id") @db.Uuid
  scopeType    String   @map("scope_type") // domain|obligation
  domainId     String?  @map("domain_id") @db.Uuid
  obligationId String?  @map("obligation_id") @db.Uuid
  isInScope    Boolean  @default(true) @map("is_in_scope")
  rationale    String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @map("updated_at")

  evaluation   CorpusEvaluation @relation(fields: [evaluationId], references: [id])
  domain       CorpusDomain?    @relation(fields: [domainId], references: [id])
  obligation   CorpusObligation? @relation(fields: [obligationId], references: [id])

  @@unique([evaluationId, scopeType, domainId, obligationId], name: "uq_eval_scope")
  @@map("corpus_evaluation_scope")
}

model CorpusEvaluationTestRun {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  evaluationId      String   @map("evaluation_id") @db.Uuid
  testControlRunId  String   @map("test_control_run_id") @db.Uuid
  included          Boolean  @default(true)

  evaluation        CorpusEvaluation @relation(fields: [evaluationId], references: [id])

  @@map("corpus_evaluation_test_run")
}

model CorpusEvaluationArtifact {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  evaluationId   String   @map("evaluation_id") @db.Uuid
  artifactId     String   @map("artifact_id") @db.Uuid
  status         String

  evaluation     CorpusEvaluation @relation(fields: [evaluationId], references: [id])

  @@map("corpus_evaluation_artifact")
}

model CorpusModelRun {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String   @map("tenant_id") @db.Uuid
  assessmentId         String   @map("assessment_id") @db.Uuid
  evaluationId         String   @map("evaluation_id") @db.Uuid
  parameterSetId       String   @map("parameter_set_id") @db.Uuid
  frameworkVersionId   String   @map("framework_version_id") @db.Uuid
  engineVersion        String   @map("engine_version")
  runStatus            String   @map("run_status")
  inputHash            String?  @map("input_hash")
  outputHash           String?  @map("output_hash")
  createdAt            DateTime @default(now()) @map("created_at")
  endedAt              DateTime? @map("ended_at")

  assessment           CorpusAssessment @relation(fields: [assessmentId], references: [id])
  evaluation           CorpusEvaluation @relation(fields: [evaluationId], references: [id])
  parameterSet         CorpusParameterSet @relation(fields: [parameterSetId], references: [id])
  frameworkVersion     CorpusFrameworkVersion @relation(fields: [frameworkVersionId], references: [id])
  
  scores               CorpusModelRunScore[]
  controls             CorpusModelRunControl[]
  obligations          CorpusModelRunObligation[]
  triggers             CorpusModelRunTrigger[]

  @@map("corpus_model_run")
}

model CorpusModelRunScore {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelRunId     String   @map("model_run_id") @db.Uuid
  scoreValue     Decimal  @map("score_value")
  readinessScore Decimal? @map("readiness_score") @db.Decimal(5, 2)

  modelRun       CorpusModelRun @relation(fields: [modelRunId], references: [id])

  @@map("corpus_model_run_score")
}

model CorpusModelRunControl {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelRunId   String   @map("model_run_id") @db.Uuid
  controlId    String   @map("control_id") @db.Uuid
  score        Decimal

  modelRun     CorpusModelRun @relation(fields: [modelRunId], references: [id])
  control      CorpusControl @relation(fields: [controlId], references: [id])

  @@map("corpus_model_run_control")
}

model CorpusModelRunObligation {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelRunId   String   @map("model_run_id") @db.Uuid
  obligationId String   @map("obligation_id") @db.Uuid
  score        Decimal

  modelRun     CorpusModelRun @relation(fields: [modelRunId], references: [id])
  obligation   CorpusObligation @relation(fields: [obligationId], references: [id])

  @@map("corpus_model_run_obligation")
}

model CorpusModelRunTrigger {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  modelRunId   String   @map("model_run_id") @db.Uuid
  triggerCode  String   @map("trigger_code")
  triggerFired Boolean  @map("trigger_fired")
  triggerValue Json?    @map("trigger_value")
  justification String?

  modelRun     CorpusModelRun @relation(fields: [modelRunId], references: [id])

  @@map("corpus_model_run_trigger")
}

model CorpusParameterSet {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  statusId       Int      @map("status_id")
  version        String
  hash           String?
  createdAt      DateTime @default(now()) @map("created_at")

  values         CorpusParameterValue[]
  weights        CorpusParameterObligationWeight[]
  modelRuns      CorpusModelRun[]

  @@map("corpus_parameter_set")
}

model CorpusParameterValue {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  parameterSetId String   @map("parameter_set_id") @db.Uuid
  key            String
  value          Decimal

  parameterSet   CorpusParameterSet @relation(fields: [parameterSetId], references: [id])

  @@map("corpus_parameter_value")
}

model CorpusParameterObligationWeight {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  parameterSetId String   @map("parameter_set_id") @db.Uuid
  obligationId   String   @map("obligation_id") @db.Uuid
  weight         Decimal

  parameterSet   CorpusParameterSet @relation(fields: [parameterSetId], references: [id])
  obligation     CorpusObligation?   @relation(fields: [obligationId], references: [id])

  @@map("corpus_parameter_obligation_weight")
}

model CorpusAuditFindingType {
  id                      Int      @id @db.SmallInt
  code                    String   @unique
  name                    String
  description             String?
  defaultSeverity        Int      @default(3) @map("default_severity") @db.SmallInt
  defaultExposureFloor    Decimal  @default(0.0000) @map("default_exposure_floor") @db.Decimal(6, 4)
  defaultReadinessPenalty Int      @default(0) @map("default_readiness_penalty")
  defaultOwnerRole        String?  @map("default_owner_role")
  defaultDueDays          Int?     @map("default_due_days")
  isActive                Boolean  @default(true) @map("is_active")
  sortOrder               Int      @default(0) @map("sort_order")

  findings                CorpusAuditFinding[]

  @@map("corpus_catalog_audit_finding_type")
}

model CorpusAuditFinding {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  code              String
  title             String
  description       String?
  
  eventTypeId       Int      @map("event_type_id") @db.SmallInt
  severity          Int      @default(3) @db.SmallInt // 1-5
  status            String   @default("open") // open|closed|suppressed
  
  exposureFloor      Decimal  @default(0.0000) @map("exposure_floor") @db.Decimal(6, 4)
  readinessPenalty   Int      @default(0) @map("readiness_penalty")
  ownerRole          String?  @map("owner_role")
  dueDate            DateTime? @map("due_date") @db.Date
  
  rootCause          String?  @map("root_cause")
  evidenceLinks      Json     @default("[]") @map("evidence_links")
  dedupeKey          String?  @unique @map("dedupe_key")
  
  severityId        Int      @map("severity_id")
  statusId          Int      @map("status_id")
  
  evaluationId      String?  @map("evaluation_id") @db.Uuid
  controlId         String?  @map("control_id") @db.Uuid
  obligationId      String?  @map("obligation_id") @db.Uuid
  riskId            String?  @map("risk_id") @db.Uuid
  testControlRunId  String?  @map("test_control_run_id") @db.Uuid
  
  createdAt         DateTime @default(now()) @map("created_at")
  createdBy         String?  @map("created_by") @db.Uuid
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
  updatedBy         String?  @map("updated_by") @db.Uuid
  closedAt          DateTime? @map("closed_at")
  closedBy          String?  @map("closed_by") @db.Uuid
  metadata          Json?    @default("{}")

  eventType         CorpusAuditFindingType @relation(fields: [eventTypeId], references: [id])

  @@index([evaluationId, status])
  @@index([evaluationId, severity])
  @@map("corpus_audit_finding")
}

model CorpusAuditLog {
  id         BigInt   @id @default(autoincrement())
  tenantId   String?  @map("tenant_id") @db.Uuid
  entityName String   @map("entity_name")
  entityId   String   @map("entity_id") @db.Uuid
  action     String
  oldData     Json?    @map("old_data")
  newData     Json?    @map("new_data")
  changedBy  String?  @map("changed_by") @db.Uuid
  changedAt  DateTime @default(now()) @map("changed_at")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")

  @@map("corpus_audit_log")
}

model CorpusSuperintendence {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId          String   @map("company_id") @db.Uuid
  jurisdictionId     String   @map("jurisdiction_id") @db.Uuid
  frameworkId        String   @map("framework_id") @db.Uuid
  frameworkVersionId String   @map("framework_version_id") @db.Uuid
  profileName        String   @map("profile_name")
  status             String   @default("draft")
  alpha              Decimal  @default(0.30)
  beta               Decimal  @default(0.25)
  gamma              Decimal  @default(4.00)
  materialMultiplier Decimal  @default(1.00) @map("material_multiplier")
  hashSnapshot       String?  @map("hash_snapshot")
  isActive           Boolean  @default(false) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @default(now()) @map("updated_at")
  createdBy          String?  @map("created_by") @db.Uuid
  updatedBy          String?  @map("updated_by") @db.Uuid

  eventWeights       CorpusSuperintendenceEventWeight[]
  triggerThresholds  CorpusSuperintendenceTriggerThreshold[]

  @@map("corpus_superintendence")
}

model CorpusSuperintendenceEventWeight {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  superintendenceId String   @map("superintendence_id") @db.Uuid
  eventTypeCode     String   @map("event_type_code")
  sensitivityWeight Decimal  @default(1.00) @map("sensitivity_weight")
  severityMultiplier Decimal @default(1.00) @map("severity_multiplier")
  readinessPenalty  Int      @default(10) @map("readiness_penalty")
  exposureFloor     Decimal  @default(0.00) @map("exposure_floor")
  isHardTrigger     Boolean  @default(false) @map("is_hard_trigger")

  superintendence   CorpusSuperintendence @relation(fields: [superintendenceId], references: [id])

  @@map("corpus_superintendence_event_weight")
}

model CorpusSuperintendenceTriggerThreshold {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  superintendenceId String   @map("superintendence_id") @db.Uuid
  triggerCode       String   @map("trigger_code")
  thresholdValue    Decimal  @map("threshold_value")
  exposureFloor     Decimal  @default(0.70) @map("exposure_floor")
  readinessFloor    Int      @default(0) @map("readiness_floor")
  enabled           Boolean  @default(true)

  superintendence   CorpusSuperintendence @relation(fields: [superintendenceId], references: [id])

  @@map("corpus_superintendence_trigger_threshold")
}
